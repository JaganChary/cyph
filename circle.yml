machine:
  environment:
    DOCKER_IMAGE: cyph/circleci:${CIRCLE_BRANCH}
  services:
    - docker

dependencies:
  pre:
    - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS}

  override:
    - docker pull ${DOCKER_IMAGE} || true
    - sed -i 's/.*emsdk.*//g' Dockerfile
    - sed -i 's|#CIRCLECI:||g' Dockerfile
    - sed -i "s|GETLIBS_BASE64|$(base64 commands/getlibs.sh | tr -d '\n')|g" Dockerfile
    - sed -i "s|FB_PACKAGE_BASE64|$(base64 shared/lib/js/module_locks/firebase/package.json | tr -d '\n')|g" Dockerfile
    - sed -i "s|FB_LOCK_BASE64|$(base64 shared/lib/js/module_locks/firebase/yarn.lock | tr -d '\n')|g" Dockerfile
    - sed -i "s|TSN_PACKAGE_BASE64|$(base64 shared/lib/js/module_locks/ts-node/package.json | tr -d '\n')|g" Dockerfile
    - sed -i "s|TSN_LOCK_BASE64|$(base64 shared/lib/js/module_locks/ts-node/yarn.lock | tr -d '\n')|g" Dockerfile
    - sed -i "s|TSL_PACKAGE_BASE64|$(base64 shared/lib/js/module_locks/tslint/package.json | tr -d '\n')|g" Dockerfile
    - sed -i "s|TSL_LOCK_BASE64|$(base64 shared/lib/js/module_locks/tslint/yarn.lock | tr -d '\n')|g" Dockerfile
    - sed -i "s|PACKAGE_BASE64|$(base64 shared/lib/js/package.json | tr -d '\n')|g" Dockerfile
    - sed -i "s|LOCK_BASE64|$(base64 shared/lib/js/yarn.lock | tr -d '\n')|g" Dockerfile
    - docker build --rm=false -t ${DOCKER_IMAGE} .
    - docker push ${DOCKER_IMAGE}

test:
  override:
    - docker run -v ${PWD}:/cyph ${DOCKER_IMAGE} bash -c 'source ~/.bashrc ; /cyph/commands/build.sh'
